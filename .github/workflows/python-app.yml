- name: Setup Python environment
  run: |
    # Устанавливаем PYTHONPATH так, чтобы Python видел корень проекта
    echo "PYTHONPATH=${{ github.workspace }}" >> $GITHUB_ENV
    echo "PYTHONPATH set to: ${{ github.workspace }}"

- name: Verify project structure
  run: |
    echo "=== Project structure ==="
    pwd
    ls -la
    echo ""
    echo "=== Checking src/ directory ==="
    if [ -d "src" ]; then
      echo "✓ src/ exists"
      find src/ -type f -name "*.py" | head -20
    else
      echo "✗ src/ NOT FOUND - creating minimal structure"
      mkdir -p src/{bots,data,execution,risk,web}
      touch src/__init__.py
      for dir in bots data execution risk web; do
        touch src/$dir/__init__.py
      done
      echo "# Placeholder for BaseTradingBot" > src/bots/BaseTradingBot.py
      echo "# Placeholder for MarketData" > src/data/MarketData.py
      echo "# Placeholder for OrderExecutor" > src/execution/OrderExecutor.py
      echo "# Placeholder for RiskManager" > src/risk/RiskManager.py
      echo "# Placeholder for web module" > src/web/__init__.py
    fi

- name: Test Python imports
  run: |
    echo "=== Testing Python imports ==="
    python -c "
import sys
print(f'Python {sys.version}')
print(f'Current directory: {sys.path[0]}')
print(f'PYTHONPATH: {sys.path}')

# Тестируем импорты
try:
    import src
    print('✓ src imported successfully')
except Exception as e:
    print(f'✗ src import failed: {e}')

try:
    from src.bots import BaseTradingBot
    print('✓ src.bots.BaseTradingBot imported successfully')
except Exception as e:
    print(f'✗ src.bots.BaseTradingBot import failed: {e}')

try:
    from src.data import MarketData
    print('✓ src.data.MarketData imported successfully')
except Exception as e:
    print(f'✗ src.data.MarketData import failed: {e}')
"

- name: Run tests
  run: |
    echo "=== TESTING ALL MODULES ==="
    echo "=== STARTING MODULE TESTS ==="
    
    # Создаем временный тестовый скрипт
    cat > run_import_tests.py << 'EOF'
import sys
import os

print(f"Python path: {sys.path}")
print(f"Current dir: {os.getcwd()}")
print(f"Files in current dir: {os.listdir('.')}")

if os.path.exists('src'):
    print(f"Files in src: {os.listdir('src')}")

test_modules = [
    ('src', 'Core module'),
    ('src.web', 'Web module'),
    ('src.bots.BaseTradingBot', 'src.bots.BaseTradingBot'),
    ('src.data.MarketData', 'src.data.MarketData'),
    ('src.execution.OrderExecutor', 'src.execution.OrderExecutor'),
    ('src.risk.RiskManager', 'src.risk.RiskManager')
]

all_passed = True

for module_name, display_name in test_modules:
    try:
        __import__(module_name)
        print(f"✓ {display_name}: Import successful")
    except ImportError as e:
        print(f"❌ {display_name}: {e}")
        all_passed = False
    except Exception as e:
        print(f"⚠️ {display_name}: Unexpected error - {e}")
        all_passed = False

if all_passed:
    print("=== ALL TESTS PASSED ===")
    sys.exit(0)
else:
    print("=== SOME TESTS FAILED ===")
    sys.exit(1)
EOF
    
    # Запускаем тестовый скрипт
    python run_import_tests.py
